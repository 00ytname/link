<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¸ìŠ¤íƒ€ê·¸ë¨ / í‹±í†¡ ê²€ìƒ‰ (ì•„ì´ë””/ì´ë¦„ ë¶„ë¦¬, ìˆ˜ì •/ì‚­ì œ)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }

    .nav {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .nav a {
      text-decoration: none;
      font-weight: bold;
      color: #333;
    }

    .nav a:hover {
      text-decoration: underline;
    }

    label, select, input, button {
      font-size: 1rem;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    input[type="text"], select {
      max-width: 100%;
      padding: 6px;
    }

    button {
      padding: 6px 12px;
    }

    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    a.link-icon {
      font-size: 1.2rem;
      text-decoration: none;
    }

    button.editBtn,
    button.saveBtn,
    button.deleteBtn {
      cursor: pointer;
      padding: 4px 8px;
      margin-right: 4px;
      font-size: 0.9rem;
    }

    input.editable,
    select.editable {
      font-size: 0.9rem;
      padding: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      label, select, input, button {
        font-size: 0.95rem;
      }
      .nav {
        flex-direction: column;
        gap: 5px;
      }
      th, td {
        font-size: 0.85rem;
        padding: 6px;
      }
      button.editBtn,
      button.saveBtn,
      button.deleteBtn {
        font-size: 0.85rem;
        padding: 4px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">ì…ë ¥</a>
    <a href="instagram.html">ì¸ìŠ¤íƒ€ê·¸ë¨</a>
    <a href="tiktok.html">í‹±í†¡</a>
    <a href="search.html">ê²€ìƒ‰</a>
  </div>

  <h1>ì¸ìŠ¤íƒ€ê·¸ë¨ / í‹±í†¡ ê²€ìƒ‰ ë° ê´€ë¦¬</h1>

  <div class="form-group">
    <label for="platformSelect">í”Œë«í¼:</label>
    <select id="platformSelect">
      <option value="instagram">ì¸ìŠ¤íƒ€ê·¸ë¨</option>
      <option value="tiktok">í‹±í†¡</option>
    </select>

    <label for="groupSelect">ê·¸ë£¹:</label>
    <select id="groupSelect" disabled>
      <option value="">-- ì „ì²´ ê·¸ë£¹ --</option>
    </select>

    <label for="idNameInput">ì•„ì´ë”” / ì´ë¦„ ê²€ìƒ‰:</label>
    <input type="text" id="idNameInput" placeholder="ì•„ì´ë”” ë˜ëŠ” ì´ë¦„ ì¼ë¶€ ì…ë ¥" />

    <button id="searchBtn">ê²€ìƒ‰</button>
  </div>

  <div class="table-container">
    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>ì•„ì´ë””</th>
          <th>ì´ë¦„</th>
          <th>ê·¸ë£¹</th>
          <th>ê¸°ë¡ë‚ ì§œ</th>
          <th>ìˆ˜ì •ë‚ ì§œ</th>
          <th>ë§í¬</th>
          <th>ìˆ˜ì •</th>
          <th>ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0FkKVoevwIkIAx64PycLm_bZDXk1Rflc",
      authDomain: "instatiktok-1961b.firebaseapp.com",
      projectId: "instatiktok-1961b",
      storageBucket: "instatiktok-1961b.appspot.com",
      messagingSenderId: "256647744023",
      appId: "1:256647744023:web:1de0d62b5189088378aa52"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const platformSelect = document.getElementById("platformSelect");
    const groupSelect = document.getElementById("groupSelect");
    const idNameInput = document.getElementById("idNameInput");
    const searchBtn = document.getElementById("searchBtn");
    const resultTable = document.getElementById("resultTable");
    const resultBody = resultTable.querySelector("tbody");

    // í”Œë«í¼ë³„ ê·¸ë£¹ ìºì‹œ
    const platformGroupsCache = {
      instagram: new Set(),
      tiktok: new Set()
    };

    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
    function formatDate(dateStr) {
      return dateStr || "-";
    }

    // í˜„ì¬ ì‹œê°„ ë¬¸ìì—´
    function getCurrentTimestamp() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
    }

    // í”Œë«í¼ ë³€ê²½ ì‹œ ê·¸ë£¹ ë¡œë“œ
    platformSelect.addEventListener("change", () => {
      loadGroups(platformSelect.value);
    });

    // ê·¸ë£¹ ë¡œë“œ í•¨ìˆ˜
    async function loadGroups(platform) {
      groupSelect.innerHTML = '<option value="">-- ì „ì²´ ê·¸ë£¹ --</option>';
      groupSelect.disabled = true;

      if (platformGroupsCache[platform].size > 0) {
        for (const g of platformGroupsCache[platform]) {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          groupSelect.appendChild(opt);
        }
        groupSelect.disabled = false;
        return;
      }

      try {
        const snapshot = await getDocs(collection(db, platform));
        const groups = new Set();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.group) groups.add(data.group);
        });
        platformGroupsCache[platform] = groups;

        for (const g of groups) {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          groupSelect.appendChild(opt);
        }
        groupSelect.disabled = false;
      } catch (e) {
        alert("ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
      }
    }

    // ì´ë¦„/ì•„ì´ë”” í•„í„° ë§¤ì¹­ í•¨ìˆ˜ (ë¶€ë¶„ì¼ì¹˜)
    function matchesIdNameFilter(filter, id, name) {
      if (!filter) return true;
      const f = filter.toLowerCase();
      const idLower = (id || "").toLowerCase();
      const nameLower = (name || "").toLowerCase();
      return idLower.includes(f) || nameLower.includes(f);
    }

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchBtn.onclick = async () => {
      const platform = platformSelect.value;
      const group = groupSelect.value.trim();
      const idNameFilter = idNameInput.value.trim();

      if (!platform) {
        alert("í”Œë«í¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      resultBody.innerHTML = "";
      resultTable.style.display = "none";

      try {
        const snapshot = await getDocs(collection(db, platform));
        let results = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (
            !matchesIdNameFilter(idNameFilter, data.id, data.name) ||
            (group && data.group !== group)
          ) {
            return;
          }
          results.push({ docId: docSnap.id, ...data });
        });

        if (results.length === 0) {
          alert("ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ìµœì‹ ìˆœ ì •ë ¬
        results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        for (const item of results) {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td class="id-cell readonly-text" data-id="${item.docId}">
              ${escapeHtml(item.id)}
            </td>
            <td class="name-cell readonly-text" data-id="${item.docId}">
              ${escapeHtml(item.name || "")}
            </td>
            <td class="group-cell readonly-text" data-id="${item.docId}">
              ${escapeHtml(item.group || "")}
            </td>
            <td>${formatDate(item.timestamp)}</td>
            <td>${formatDate(item.lastEdited)}</td>
            <td><a href="${item.link}" class="link-icon" target="_blank" rel="noopener noreferrer">ğŸ“</a></td>
            <td><button class="editBtn" data-id="${item.docId}">âœï¸ ìˆ˜ì •</button></td>
            <td><button class="deleteBtn" data-id="${item.docId}">âŒ ì‚­ì œ</button></td>
          `;

          resultBody.appendChild(tr);
        }

        resultTable.style.display = "table";

        // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        document.querySelectorAll(".editBtn").forEach(btn => {
          btn.onclick = onEditClick;
        });

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        document.querySelectorAll(".deleteBtn").forEach(btn => {
          btn.onclick = onDeleteClick;
        });

      } catch (e) {
        alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
      }
    };

    // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': "&amp;",
          '<': "&lt;",
          '>': "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[m];
      });
    }

    // í¸ì§‘ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    async function onEditClick(e) {
      const btn = e.target;
      const docId = btn.dataset.id;
      const tr = btn.closest("tr");

      const idCell = tr.querySelector(".id-cell");
      const nameCell = tr.querySelector(".name-cell");
      const groupCell = tr.querySelector(".group-cell");

      const isEditing = nameCell.querySelector("input") !== null;

      if (!isEditing) {
        // ìˆ˜ì • ëª¨ë“œ ì§„ì…: input, select ìƒì„±
        const currentId = idCell.textContent.trim();
        const currentName = nameCell.textContent.trim();

        // idëŠ” ìˆ˜ì • ë¶ˆê°€ â†’ í…ìŠ¤íŠ¸ë¡œ ê³ ì •
        idCell.innerHTML = `<span style="user-select:none; font-weight:bold;">${escapeHtml(currentId)}</span>`;

        // ì´ë¦„ input ìƒì„±
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "editable";
        nameInput.value = currentName;
        nameCell.innerHTML = "";
        nameCell.appendChild(nameInput);

        // ê·¸ë£¹ select ìƒì„±
        const select = document.createElement("select");
        select.className = "editable";

        // ë¹ˆê°’ ì˜µì…˜
        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "(ì—†ìŒ)";
        select.appendChild(emptyOpt);

        // ê·¸ë£¹ ëª©ë¡ ì„¸íŒ…
        for (const g of platformGroupsCache[platformSelect.value]) {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          select.appendChild(opt);
        }

        const currentGroup = groupCell.textContent.trim();
        select.value = currentGroup || "";
        groupCell.innerHTML = "";
        groupCell.appendChild(select);

        btn.textContent = "ğŸ’¾ ì €ì¥";

      } else {
        // ì €ì¥ ëª¨ë“œ: Firestore ì—…ë°ì´íŠ¸
        const nameInput = nameCell.querySelector("input");
        const selectGroup = groupCell.querySelector("select");

        const newName = nameInput.value.trim();
        const newGroup = selectGroup.value;

        if (newGroup && !platformGroupsCache[platformSelect.value].has(newGroup)) {
          platformGroupsCache[platformSelect.value].add(newGroup);
          alert(`ìƒˆ ê·¸ë£¹ "${newGroup}" ì´(ê°€) ìë™ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        const docRef = doc(db, platformSelect.value, docId);
        try {
          await updateDoc(docRef, {
            name: newName,
            group: newGroup,
            lastEdited: getCurrentTimestamp()
          });
          alert("ìˆ˜ì • ì™„ë£Œ");
          searchBtn.click(); // ì¬ê²€ìƒ‰í•´ì„œ UI ê°±ì‹ 
        } catch (err) {
          alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message);
        }
      }
    }

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    async function onDeleteClick(e) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const btn = e.target;
      const docId = btn.dataset.id;
      const docRef = doc(db, platformSelect.value, docId);

      try {
        await deleteDoc(docRef);
        alert("ì‚­ì œ ì™„ë£Œ");
        searchBtn.click(); // ì¬ê²€ìƒ‰í•´ì„œ UI ê°±ì‹ 
      } catch (err) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
      }
    }

    // ì´ˆê¸° ê·¸ë£¹ ë¡œë“œ (ê¸°ë³¸ instagram)
    loadGroups("instagram");
  </script>
</body>
</html>
